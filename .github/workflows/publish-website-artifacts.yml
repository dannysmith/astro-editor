name: Publish Website Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to download artifacts from (e.g. v1.0.9)'
        required: true

jobs:
  update-website:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main

      - name: Download release assets
        run: |
          mkdir -p /tmp/artifacts
          gh release download "$RELEASE_TAG" \
            --pattern "*.dmg" \
            --pattern "*.msi" \
            --pattern "*.AppImage" \
            --dir /tmp/artifacts

          if [ -z "$(ls -A /tmp/artifacts)" ]; then
            echo "::error::No artifacts downloaded from release $RELEASE_TAG"
            exit 1
          fi

          echo "Downloaded artifacts:"
          ls -la /tmp/artifacts/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy artifacts to website public folder
        run: |
          mkdir -p website/public

          # Copy macOS DMG
          DMG_FILE=$(find /tmp/artifacts -name "*.dmg" | head -1)
          if [ -n "$DMG_FILE" ]; then
            cp "$DMG_FILE" website/public/astro-editor-latest.dmg
            echo "Copied DMG: $DMG_FILE"
          fi

          # Copy Windows MSI
          MSI_FILE=$(find /tmp/artifacts -name "*.msi" | head -1)
          if [ -n "$MSI_FILE" ]; then
            cp "$MSI_FILE" website/public/astro-editor-latest.msi
            echo "Copied MSI: $MSI_FILE"
          fi

          # Copy Linux AppImage
          APPIMAGE_FILE=$(find /tmp/artifacts -name "*.AppImage" | head -1)
          if [ -n "$APPIMAGE_FILE" ]; then
            cp "$APPIMAGE_FILE" website/public/astro-editor-latest.AppImage
            echo "Copied AppImage: $APPIMAGE_FILE"
          fi

          echo "Website public folder contents:"
          ls -la website/public/*.dmg website/public/*.msi website/public/*.AppImage 2>/dev/null || true

      - name: Generate release page
        run: |
          # Fetch release body
          RELEASE_BODY=$(gh release view "$RELEASE_TAG" --json body -q .body)
          VERSION="${RELEASE_TAG#v}"
          DATE=$(gh release view "$RELEASE_TAG" --json publishedAt -q .publishedAt | cut -dT -f1)

          # Sanitise body for MDX:
          # - Strip leading H2 title
          # - Strip "Installation Instructions" section
          # - Strip "Full Changelog" links
          # - Escape curly braces outside code spans/blocks
          CLEAN_BODY=$(echo "$RELEASE_BODY" | \
            sed '/^## *\(ðŸš€ *\)\?Astro Editor v[0-9]/d' | \
            sed '/^### Installation Instructions/,$d' | \
            sed '/^\*\*Full Changelog\*\*/d' | \
            awk '
              /^```/ { in_code = !in_code }
              in_code { print; next }
              {
                line = ""
                n = split($0, chars, "")
                in_tick = 0
                for (i = 1; i <= n; i++) {
                  if (chars[i] == "`") in_tick = !in_tick
                  if (!in_tick && chars[i] == "{") { line = line "\\&#123;"; continue }
                  if (!in_tick && chars[i] == "}") { line = line "\\&#125;"; continue }
                  line = line chars[i]
                }
                print line
              }
            ' | \
            sed -e :a -e '/^[[:space:]]*$/{ $d; N; ba; }')

          # Generate MDX file
          RELEASES_DIR="website/src/content/docs/releases"
          mkdir -p "$RELEASES_DIR"
          OUTPUT_FILE="$RELEASES_DIR/${VERSION}.mdx"

          cat > "$OUTPUT_FILE" << FRONTMATTER
          ---
          title: 'v${VERSION}'
          description: 'Astro Editor v${VERSION}'
          date: ${DATE}
          slug: 'releases/v${VERSION}'
          ---
          FRONTMATTER

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' "$OUTPUT_FILE"

          if [ -n "$CLEAN_BODY" ]; then
            echo "" >> "$OUTPUT_FILE"
            echo "$CLEAN_BODY" >> "$OUTPUT_FILE"
          fi

          echo "" >> "$OUTPUT_FILE"
          echo "---" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "[View on GitHub](https://github.com/dannysmith/astro-editor/releases/tag/${RELEASE_TAG})" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"

          echo "Generated release page: $OUTPUT_FILE"
          cat "$OUTPUT_FILE"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit website artifacts and release page
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add website/public/astro-editor-latest.dmg website/public/astro-editor-latest.msi website/public/astro-editor-latest.AppImage 2>/dev/null || true
          git add website/src/content/docs/releases/*.mdx 2>/dev/null || true
          git commit -m "chore: update installers and add release page for $RELEASE_TAG" || echo "No changes to commit"
          git pull --rebase origin main
          git push origin main

      - name: Trigger website deploy
        run: gh workflow run deploy-website.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
